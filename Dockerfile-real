FROM ubuntu:20.04

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install required packages
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    wget \
    pkg-config \
    curl \
    unzip \
    python3 \
    python3-pip \
    libgtk-3-dev \
    libcurl4-openssl-dev \
    libjsoncpp-dev \
    libgtkmm-3.0-dev \
    libcurlpp-dev \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy source files
COPY src/ /app/src/
COPY include/ /app/include/
COPY resources/ /app/resources/
COPY CMakeLists.txt /app/

# Configure and build with pthread fix
RUN mkdir -p build && \
    cd build && \
    cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-pthread" && \
    make -j$(nproc)

# Create Kindle package
RUN mkdir -p kindle-package/gtkks-kindle && \
    cp build/gtkks kindle-package/gtkks-kindle/ && \
    cp -r resources kindle-package/gtkks-kindle/ && \
    echo '#!/bin/sh\ncd "$(dirname "$0")"\n./gtkks "$@"' > kindle-package/gtkks-kindle/gtkks.sh && \
    chmod +x kindle-package/gtkks-kindle/gtkks.sh && \
    echo "# GTKKS for Kindle\n\nThis is the GTKKS application for Kindle.\n\nTo run the application, execute the gtkks.sh script." > kindle-package/gtkks-kindle/README.md && \
    cd kindle-package && \
    tar -czvf gtkks-kindle.tar.gz gtkks-kindle

# Command to copy the package to the host
CMD cp kindle-package/gtkks-kindle.tar.gz /output/ 